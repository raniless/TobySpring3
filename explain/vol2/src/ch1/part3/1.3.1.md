# 1.3.1 프로토타입 스코프
- 싱글톤 스코프
  + 컨텍스트당 한 개의 빈 오브젝트만 만들어지게 한다.
  + 하나의 빈을 여러 개의 빈에서 DI 하더라도 매번 동일한 오브젝트가 주입된다.
  + 컨테이너에 getBean() 메소드를 사용해 의존객체 조회(DL)를 하더라도 매번 같은 오브젝트가 리턴됨이 보장된다.

- 프로토타입 스코프
  + 컨테이너에 빈을 요청할 때마다 매번 새로운 오브젝트를 생성해준다.

## 프로토타입 빈의 생명주기와 종속성
- 프로토타입 빈 오브젝트는 한 번 DL이나 DI를 통해 컨테이너 밖으로 전달된 후에는 이 오브젝트는 더 이상 스프링이 관리하는 빈이 아니다.
- 한 번 만들어진 프로토타입 빈 오브젝트는 다시 컨테이너를 통해 가져올 방법이 없고, 빈이 제거되기 전에 빈이 사용한 리소스를 정리하기 위해 호출하는 메소드도 이용할 수 없다.
- 프로토타입 빈은 주입반은 오브젝트에 종속적이다.(ex. 주입받은 빈이 싱글톤이면 주입된 프로토타입 빈도 싱글톤 생명주기)

## 프로토타입 빈의 용도
- 서버가 요청에 따라 매번 독립적인 오브젝트를 만들어 필요한 빈에게 DI를 해줘야 하는 경우 사용
- 프로토타입 빈은 오브젝트의 생성과 DI 작업까지 마친 후에 컨테이너가 돌려준다.
- (예제) A/S 신청 접수
  + 신청 폼 클래스
    ```java
    public class ServiceRequest {
      String customerNo;
      String productNo;
      String description;
      ...
    }
    ```
   + ServiceRequest 웹 컨트롤러 (단순, 원시적인 방법)
     ```java
     public void serviceRequestFormSubmit(HttpServletRequest request) {
       ServiceRequest serviceRequest = new ServiceRequest();    //매 요청마다 새로 생성
       serviceRequest.setCustomerNo(request.getParameter("custno"));
       ...
       serviceRequestService.addNewServiceRequest(serviceRequest);
     }
     ```
   + ServiceRequest 서비스 계층
     ```java
     public void addNewServiceRequest(ServiceRequest serviceRequest) {
       Customer customer = customerDao.findCustomerByNo(serviceRequest.getCustomerNo());
       ...
       serviceRequestDao.add(serviceRequest, customer);

       emailService.sendMail(customer.getEmail());
     }
     ```
   + 위의 아키텍처 구조에서 customerNo 입력방식이 id로 변경되면 ServiceRequestService 코드도 변경되어야 한다.(데이터 중심)
   + 오브젝트 중심의 구조로 변경이 필요하다.
   + 수정된 ServiceRequest
     ```java
     public class ServiceRequest {
       Customer customer;    // customerNo 값 대신 Customer 오브젝트 자체를 갖고 있게 한다.
       String productNo;
       String description;
       ...
     }
     ```
   + 수정된 ServiceRequest 서비스 계층
     ```java
     public void addNewServiceRequest(ServiceRequest serviceRequest) {
       serviceRequestDao.add(serviceRequest);
       emailService.sendMail(serviceRequest.getCustomer().getEmail());
     }
     ```
   + 문자열로된 고객번호를 입력받을텐데 어떻게 Customer 오브젝트로 바꿔서 ServiceRequest에 넣어줄 수 있을까?  
     : ServiceRequest 자신이 customerNo를 가지고 CustomerDao에 요청해서 Customer 오브젝트를 찾아오면 된다.
     ```java
     public class ServiceRequest {
       Customer customer;
       ...
       @Autowired
       CustomerDao customerDao;     
       
       public void setCustomerByCustomerNo(String customerNo) {
         customer = customerDao.findCustomerByNo(customerNo);
       }
     }
     ```
   + 웹 컨트롤러에서는 setCustomerByCustomerNo() 메소드를 호출하기만 하면 된다.
   + ServiceRequestService는 ServiceRequest의 customer 오브젝트가 어떻게 만들어졌는지에 대해서는 전혀 신경쓰지 않아도 된다.
   + 폼에서 입력받는 값이 id라면 ServiceRequest에 추가해주고 컨트롤러를 통해 id 값을 넣어주게만 하면 그만이다.
   + customerId를 이용한 Customer 검색
     ```java
     public void setCustomerByCustomerId(int customerId) {
       customer = customerDao.getCustomer(customerId);
     }
     ```
   + 문제는 컨트롤러에서 new 키워드로 직접 생성하는 ServletRequest 오브젝트에 어떻게 DI를 적용해서 CustomerDao를 주입할 것인가?  
     : 프로토타입 스코프 빈을 이용
     ```java
     @Component
     @Scope("prototype")
     public class ServiceRequest {
       ...
     }
     ```
     ```xml
     <bean id="serviceRequest" class="...ServiceRequest" scope="prototype" />
     ```
   + ServiceRequestService에서 ServiceRequest를 빈으로 가져오게 수정
     ```java
     @Autowired
     ApplicationContext context;

     public void serviceRequestFormSubmit(HttpServletRequest request) {
       ServiceRequest serviceRequest = context.getBean(ServiceRequest.class);
       serviceRequest.setCustomerByCustomerNo(request.getParameter("custno"));
     }
     ```
   + EmailService도 ServiceRequest가 담당하도록 변경
     ```java
     @Component
     @Scope("prototype")
     public class ServiceRequest {
       Customer customer;
       @Autowired
       EmailService emailService;
       ...
       
       public void notifyServiceRequestRegistration() {
         if(this.customer.serviceNotificationMethod == NotificationMethod.EMAIL) {
           emailService.sendEmail(customer.getEmail(), "A/S 접수가 정상적으로 처리되었습니다");
         }
       }
     }
     ```
   + 깔끔하게 수정된 ServiceRequestService 메소드
     ```java
     public void addNewServiceRequest(ServiceRequest serviceRequest) {
       serviceRequestDao.add(serviceRequest);
       serviceRequest.notifyServiceRequestRegistration();    //구체적인 통보 작업은 ServiceRequest에서 알아서 담당하게 한다.
     }
     ```
   + 데이터 중심의 설계와 개발 방식을 선호한다면 굳이 프로토타입 빈을 사용안해도 상관 없다.
   + 좀 더 오브젝트 중심적이고 유연한 확장을 고려한다면 프로토타입 빈을 이용하는 편이 나을 것이다.

## DI와 DL

## 프로토타입 빈의 DL 전략